<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Rust in Raspberry Pi - My Development Cookbook</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">My Development Cookbook</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="rust-in-raspberry-pi"><a class="header" href="#rust-in-raspberry-pi">Rust in Raspberry Pi</a></h1>
<h2 id="notes"><a class="header" href="#notes">Notes</a></h2>
<ul>
<li><a href="https://github.com/diwic/dbus-rs/blob/master/libdbus-sys/cross_compile.md">https://github.com/diwic/dbus-rs/blob/master/libdbus-sys/cross_compile.md</a></li>
<li><a href="https://github.com/diwic/dbus-rs/issues/184#issuecomment-520228758">https://github.com/diwic/dbus-rs/issues/184#issuecomment-520228758</a></li>
</ul>
<h2 id="setup-wsl2-for-cross-compile"><a class="header" href="#setup-wsl2-for-cross-compile">Setup wsl2 for cross compile</a></h2>
<p>First install cross compile toolchain from <a href="https://github.com/kkibria/raspi-toolchain">https://github.com/kkibria/raspi-toolchain</a> in wsl2.
The toolchain install will create a temporary download area, which will contain the Raspbian image file.
Save the file image file or save the download area. We will need the image to install additional
libraries if required.</p>
<h2 id="setup-wsl2-for-rust"><a class="header" href="#setup-wsl2-for-rust">Setup wsl2 for rust</a></h2>
<p>Now install rust and setup rust,</p>
<pre><code>curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
. ~/.bashrc
rustc --version
rustup target add arm-unknown-linux-gnueabihf
</code></pre>
<p>We need to add our build target to <code>~/.cargo/config</code> by adding the following lines, so that rust knows which linker to use.</p>
<pre><code>[build]
# Specifies that the default target is ARM.
target = "arm-unknown-linux-gnueabihf"
rustflags = ["-L", "/lib/arm-linux-gnueabihf"]

[target.arm-unknown-linux-gnueabihf]
linker = "arm-linux-gnueabihf-gcc"
</code></pre>
<p>Now you have a working Rust cross-compilation toolchain set up.</p>
<h2 id="rust-projects-requiring-native-library"><a class="header" href="#rust-projects-requiring-native-library">rust projects requiring native library</a></h2>
<p>If you are building the native library yourself then you know what you are doing.
However, what if you are using a library that is available from raspbian apt
repository?</p>
<p>This might be the case for your project, One such example project is building
something that uses dbus. The same technique can be applied on other projects
needing to use native libraries. So we will explore the dbus case.</p>
<h2 id="pi-dbus-tooling-for-rust"><a class="header" href="#pi-dbus-tooling-for-rust">Pi Dbus tooling for rust</a></h2>
<p>We need to configure the DBus crate for cross compilation.
The DBus crate uses a build script that uses pkg_config to locate
the native dbus libraries.</p>
<p><code>cargo:rustc-link-search</code>, which is the library search path.
<code>cargo:rust-link-lib</code>, which is the name of a library to link.</p>
<p>For, this we need to add Dbus libraries to <code>~/.cargo/config</code>.</p>
<pre><code>[target.arm-unknown-linux-gnueabihf.dbus]
# Specifies the library search paths.
rustc-link-search = [
    # we will have to add the path
    # when we know where the libraries are installed.
]

# Specifies the names of the native libraries that are required to build DBus.
rustc-link-lib = [
    "dbus-1",
    "gcrypt",
    "gpg-error",
    "lz4",
    "lzma",
    "pcre",
    "selinux",
    "systemd",
]
</code></pre>
<h2 id="use-libget-to-get-the-required-libraries"><a class="header" href="#use-libget-to-get-the-required-libraries">Use <strong>libget</strong> to get the required libraries</a></h2>
<p>when you installed the toolchain in wsl2, it also installed <code>libget</code>. This automates everything
we need to do and install the libraries in <code>~/rootfs</code>.</p>
<p>We can add the libraries to our root file system from ~/rootfs using <code>rsync</code></p>
<pre><code>pushd ~/rootfs
rsync -vR --progress -rl --delete-after --safe-links {etc,lib,sbin,usr,var} $HOME/rpi/rootfs
popd
</code></pre>
<h2 id="use-liblink-to-make-links-to-library-for-rust"><a class="header" href="#use-liblink-to-make-links-to-library-for-rust">Use <strong>liblink</strong> to make links to library for rust</a></h2>
<p>When you installed the toolchain in wsl2, it also installed <code>liblink</code>. This automates everything
we need to do and install the links in <code>~/liblink</code> folder.</p>
<pre><code>liblink dbus-1 gcrypt gpg-error lz4 pcre lzma pthread dl selinux systemd
</code></pre>
<h2 id="add-the-library-search-path-for-dbus-libraries"><a class="header" href="#add-the-library-search-path-for-dbus-libraries">Add the library search path for dbus libraries</a></h2>
<p><code>~/liblink</code> we created is
not inside the rust project folder. Therefore, we can simply make
rust use this folder for linking. In such case, we will specify
the absolute path of <code>~/liblink</code>
in <code>~/.cargo/config</code> search link section, <code>rustc-link-search</code>.</p>
<p><code>~/.cargo/config</code>.</p>
<pre><code>[target.arm-unknown-linux-gnueabihf.dbus]
# Specifies the library search paths.
rustc-link-search = [
    # absolute path of ~/liblink
    /home/username/liblink
]
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../topics/crosspi.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../topics/rust-native.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../topics/crosspi.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../topics/rust-native.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
