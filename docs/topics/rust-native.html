<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Native library for Rust in Raspberry Pi - My Development Cookbook</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">My Development Cookbook</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="native-library-for-rust-in-raspberry-pi"><a class="header" href="#native-library-for-rust-in-raspberry-pi">Native library for Rust in Raspberry Pi</a></h1>
<p>We will look into problems that we face in getting native library for cross compiling
rust for pi here. This will clear your understanding of how the wsl cross compile tool
helps us dealing with those. As we mentioned before dbus based project will be a good
case study to shed light
into rust cross compiling issues related to using native library in raspberry pi.</p>
<h2 id="a-simple-dbus-project-for-testing"><a class="header" href="#a-simple-dbus-project-for-testing">A simple dbus project for testing</a></h2>
<p>To see how to set up the DBus crate for cross compilation,
we will create a new project for it. Create an empty directory somewhere
run the following,</p>
<p>Bash</p>
<pre><code># Initialize a new Rust project in the current folder.
cargo init
</code></pre>
<p>this produces following layout</p>
<pre><code>.
├── Cargo.toml
├── build.rs
└── src
    └── main.rs
</code></pre>
<p>The crate's build script is specified in Cargo.toml and is normally executed at every build.</p>
<p>Change the contents of main.rs to the following. This is just so that we actually use something
from the DBus crate, otherwise there would be no reference to it in the final executable and nothing for the linker to do.</p>
<p><code>main.rs</code></p>
<pre><code>use dbus::{BusType, Connection, Interface, Member};
use std::error::Error;

fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
    let conn = Connection::get_private(BusType::System)?;
    let obj = conn.with_path("org.freedesktop.DBus", "/", 5000);
    let msg = obj.method_call_with_args(
        &amp;Interface::from(&amp;"org.freedesktop.DBus".to_owned()),
        &amp;Member::from(&amp;"ListNames".to_owned()),
        |_| (),
    )?;
    let names: Vec&lt;String&gt; = msg.get1().unwrap_or(Vec::new());
    for name in names {
        println!("{}", name);
    }
    Ok(())
}
</code></pre>
<p>Next, add the DBus crate as an dependency by editing Cargo.toml.</p>
<p>Cargo.toml</p>
<pre><code>[dependencies]
dbus = "0.6"
</code></pre>
<p>If you try building the project at this point, you will an error
message indicating linking failure. We have to find find and download
the native arm libraries required by DBus.</p>
<h2 id="problem-statement-1-details-on-getting-missing-libraries"><a class="header" href="#problem-statement-1-details-on-getting-missing-libraries">Problem statement 1: Details on getting missing libraries</a></h2>
<p>How do you even find out which of the native packages are required?
If you take a look at this line in the DBus build script, you see that
it is looking for "dbus-1", which means libdbus-1.</p>
<p>OK, now which version of libdbus-1 is required? If you have your target system at hand,
you can connect to it and run apt show libdbus-1* on it, which should show something like this.</p>
<p>libdbus-1 Information</p>
<pre><code>Package: libdbus-1-3
Version: 1.12.16-1
...
Depends: libc6 (&gt;= 2.28), libsystemd0
...
</code></pre>
<p>If you do not have the target system at hand, there is still a way:
If you are using the Raspbian release based on Debian buster, head to
this link (this is a huge file!) and search for Package: libdbus-1 inside there.
You should see the same information.</p>
<p>Now we know that we have to download libdbus1-3 version 1.12.16-1 and it
depends on libc6 (which is provided by the cross compilation toolchain)
and libsystemd0 (which is not and which we also have to download).</p>
<p>In total, you have to download the following packages (the .deb files).
This list contains the versions for the Raspbian release based on Debian buster.
They may have changed since, check the versions installed on your target system.
Click each of the package names below and download the correct file.</p>
<pre><code>libdbus-1-3 is at version 1.12.16-1
libgcrypt20 is at version 1.8.4-5
libgpg-error0 is at version 1.35-1
liblz4-1 is at version 1.8.3-1
liblzma5 is at version 5.2.4-1
libpcre3 is at version 2:8.39-12
libselinux1 is at version 2.8-1+b1
libsystemd0 is at version 241-5+rpi1
</code></pre>
<p>Next, you have to extract each of these downloaded .deb files separately into an empty folder.</p>
<p>Bash</p>
<pre><code>dpkg-deb -x /path/to/package.deb /path/to/empty/folder
</code></pre>
<p><strong>Solution: See <a href="pirust.html#use-libget-to-get-the-required-libraries">Use <strong>libget</strong> to get the required libraries</a></strong>.</p>
<h2 id="problem-statement-2-links-to-library-for-rust"><a class="header" href="#problem-statement-2-links-to-library-for-rust">Problem statement 2: Links to library for rust</a></h2>
<p>Enter the folder you have extracted the package into and take a look at the files.
The folder structure can be ./lib/arm-linux-gnueabihf or even
./usr/lib/arm-linux-gnueabihf inside this folder.
The relevant files are the .so files. Some libraries however have another
number after the .so, for example library.so.3. In this case, you have to add
a symlink to library.so because that's where the GCC linker will look for it.
The symlink must be in the same directory as the file it points to.
To create a symlink called library.so that points to library.so.3,
you would use the following command.</p>
<pre><code class="language-bash">ln -s library.so.3 library.so
</code></pre>
<p>in our case,
for dbus, we will create links</p>
<pre><code>pushd /lib/arm-linux-gnueabihf
ln -sf libdbus-1.so.3 libdbus-1.so
ln -sf libgcrypt.so.20 libgcrypt.so
ln -sf libgpg-error.so.0 libgpg-error.so
ln -sf liblz4.so.1 liblz4.so
ln -sf libpcre.so.3 libpcre.so
ln -sf liblzma.so.5 liblzma.so
ln -sf libpthread.so.0 libpthread.so
ln -sf libdl.so.2 libdl.so
ln -sf libselinux.so.1 libselinux.so
ln -sf libsystemd.so.0 libsystemd.so
popd
</code></pre>
<p>Then take all the contents of the folder you extracted the package into and move them into another folder called libraries, which you create at the root of your Rust project. This is the location we directed the GCC linker to look for the libraries.</p>
<p>Repeat the extraction, symlinking and moving for all the other libraries.</p>
<p>Finally, after all this is done, your libraries folder should look something like this (the version numbers may differ):</p>
<pre><code>./lib/arm-linux-gnueabihf/libdbus-1.so
./lib/arm-linux-gnueabihf/libdbus-1.so.3
./lib/arm-linux-gnueabihf/libdbus-1.so.3.14.15
./lib/arm-linux-gnueabihf/libgcrypt.so
...
./usr/lib/arm-linux-gnueabihf/liblz4.so
./usr/lib/arm-linux-gnueabihf/liblz4.so.1
...
</code></pre>
<p><strong>Solution: See <a href="pirust.html#use-liblink-to-make-links-to-library-for-rust">Use <strong>liblink</strong> to make links to library for rust</a></strong>.</p>
<h2 id="problem-statement-3-specifying-library-search-path"><a class="header" href="#problem-statement-3-specifying-library-search-path">Problem statement 3: Specifying library search path</a></h2>
<p>We have to provide the <code>cargo:rustc-link-search</code> key to
make sure all the needed libraries are found.</p>
<p>There are two ways we can provide any key to Cargo:</p>
<ul>
<li>In a Cargo config file.</li>
<li>In our own build script.</li>
</ul>
<p>We need to know how Cargo handles relative paths
in rustc-link-search:
They are resolved relative to the location of the extracted crate,
not relative to a project.</p>
<p>So the takeaway is, we would have to specify the absolute library search paths if we
don't want a crate relative path. How do we provide project relative search path
if thats what we need?
In such case, we can use build script
to convert project relative paths to absolute library search paths.</p>
<p>Following is an example when we have native libraries
inside a "libraries" folder within the project,
<code>build.rs</code></p>
<pre><code>use std::env::var;

fn main() {
    // The manifest dir points to the root of the project containing this file.
    let manifest_dir = var("CARGO_MANIFEST_DIR").unwrap();
    // We tell Cargo that our native libraries are inside a "libraries" folder.
    println!("cargo:rustc-link-search={}/libraries/lib/arm-linux-gnueabihf", manifest_dir);
    println!("cargo:rustc-link-search={}/libraries/usr/lib/arm-linux-gnueabihf", manifest_dir);
}
</code></pre>
<p>Anyways, accessing dbus crate needed native libraries from a fixed location is what we need
in this case to keep thing simple and reusable.
This way we can simply use an absolute path in <code>~/.cargo/config</code> without depending
on the build script to provide search path.</p>
<p><strong>Solution: See <a href="pirust.html#add-the-library-search-path-for-dbus-libraries">Add the library search path for dbus libraries</a></strong>.</p>
<h2 id="cross-compile"><a class="header" href="#cross-compile">Cross compile</a></h2>
<p>Finally, you will be able to cross compile the test project without error messages.</p>
<p>Bash</p>
<pre><code>cargo build
#    Should print something like: 
# Finished dev [unoptimized + debuginfo] target(s) in 0.57s
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../topics/pirust.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../topics/dbuspi.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../topics/pirust.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../topics/dbuspi.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
