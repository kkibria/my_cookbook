<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Firestore matters - My Development Cookbook</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">A Few Words</a></li><li class="chapter-item expanded affix "><li class="part-title">Software Projects</li><li class="chapter-item expanded "><a href="../topics/project.html"><strong aria-hidden="true">1.</strong> How to create a new project in gitlab or github</a></li><li class="chapter-item expanded "><a href="../topics/ubuntu.html"><strong aria-hidden="true">2.</strong> Ubuntu</a></li><li class="chapter-item expanded "><a href="../topics/vscode.html"><strong aria-hidden="true">3.</strong> Using vscode</a></li><li class="chapter-item expanded "><a href="../topics/winmsi.html"><strong aria-hidden="true">4.</strong> Windows MSI installer</a></li><li class="chapter-item expanded affix "><li class="part-title">Frontend Development</li><li class="chapter-item expanded "><a href="../topics/fronend.html"><strong aria-hidden="true">5.</strong> Frontend code development</a></li><li class="chapter-item expanded "><a href="../topics/markdown.html"><strong aria-hidden="true">6.</strong> Markdown renderer and editor in browser</a></li><li class="chapter-item expanded "><a href="../topics/angular.html"><strong aria-hidden="true">7.</strong> Angular, bootstrap, firebase</a></li><li class="chapter-item expanded "><a href="../topics/firebase.html"><strong aria-hidden="true">8.</strong> Firebase matters</a></li><li class="chapter-item expanded "><a href="../topics/firestore.html" class="active"><strong aria-hidden="true">9.</strong> Firestore matters</a></li><li class="chapter-item expanded "><a href="../topics/flutter.html"><strong aria-hidden="true">10.</strong> Flutter Apps</a></li><li class="chapter-item expanded "><a href="../topics/flutterreading.html"><strong aria-hidden="true">11.</strong> Flutter matters</a></li><li class="chapter-item expanded "><a href="../topics/fluttersignin.html"><strong aria-hidden="true">12.</strong> Flutter Sign-in for your users</a></li><li class="chapter-item expanded affix "><li class="part-title">Content Management</li><li class="chapter-item expanded "><a href="../topics/jekyll.html"><strong aria-hidden="true">13.</strong> Jekyll stuff</a></li><li class="chapter-item expanded "><a href="../topics/hugo.html"><strong aria-hidden="true">14.</strong> Hugo stuff</a></li><li class="chapter-item expanded "><a href="../topics/mdbook.html"><strong aria-hidden="true">15.</strong> Build book with mdbook</a></li><li class="chapter-item expanded "><a href="../topics/gen-content.html"><strong aria-hidden="true">16.</strong> More Content Types</a></li><li class="chapter-item expanded "><a href="../topics/community.html"><strong aria-hidden="true">17.</strong> Community portal</a></li><li class="chapter-item expanded affix "><li class="part-title">Programming Languages</li><li class="chapter-item expanded "><a href="../topics/go.html"><strong aria-hidden="true">18.</strong> Go language</a></li><li class="chapter-item expanded "><a href="../topics/java.html"><strong aria-hidden="true">19.</strong> Java development</a></li><li class="chapter-item expanded "><a href="../topics/java2go.html"><strong aria-hidden="true">20.</strong> Translating Java to Go language</a></li><li class="chapter-item expanded "><a href="../topics/jslib.html"><strong aria-hidden="true">21.</strong> Javascript library</a></li><li class="chapter-item expanded "><a href="../topics/py2js.html"><strong aria-hidden="true">22.</strong> Translating Python to Javascript language</a></li><li class="chapter-item expanded "><a href="../topics/rust.html"><strong aria-hidden="true">23.</strong> Rust language</a></li><li class="chapter-item expanded "><a href="../topics/sapper.html"><strong aria-hidden="true">24.</strong> Sapper, a server side framework with Svelte</a></li><li class="chapter-item expanded "><a href="../topics/ssr.html"><strong aria-hidden="true">25.</strong> Server side and/or Headless rendering</a></li><li class="chapter-item expanded "><a href="../topics/svelte.html"><strong aria-hidden="true">26.</strong> Svelte, firebase</a></li><li class="chapter-item expanded affix "><li class="part-title">Crafting Compilers</li><li class="chapter-item expanded "><a href="../topics/parse.html"><strong aria-hidden="true">27.</strong> Compilers/Parsers</a></li><li class="chapter-item expanded "><a href="../topics/peg.html"><strong aria-hidden="true">28.</strong> Peg Parsers</a></li><li class="chapter-item expanded affix "><li class="part-title">System Development</li><li class="chapter-item expanded "><a href="../topics/cross.html"><strong aria-hidden="true">29.</strong> Cross Compilation</a></li><li class="chapter-item expanded "><a href="../topics/lfs.html"><strong aria-hidden="true">30.</strong> Linux from scratch (Part 1)</a></li><li class="chapter-item expanded "><a href="../topics/lfs2.html"><strong aria-hidden="true">31.</strong> Linux from scratch (Part 2)</a></li><li class="chapter-item expanded "><a href="../topics/lfs3.html"><strong aria-hidden="true">32.</strong> Linux from scratch (Part 3)</a></li><li class="chapter-item expanded "><a href="../topics/os.html"><strong aria-hidden="true">33.</strong> Custom O/S</a></li><li class="chapter-item expanded affix "><li class="part-title">Raspberry Pi</li><li class="chapter-item expanded "><a href="../topics/pirust.html"><strong aria-hidden="true">34.</strong> Rust in Raspberry Pi</a></li><li class="chapter-item expanded "><a href="../topics/raspberrypi.html"><strong aria-hidden="true">35.</strong> Using Raspberry Pi</a></li><li class="chapter-item expanded "><a href="../topics/embedded.html"><strong aria-hidden="true">36.</strong> Building Embedded System</a></li><li class="chapter-item expanded affix "><li class="part-title">Machine Learning</li><li class="chapter-item expanded "><a href="../topics/ai.html"><strong aria-hidden="true">37.</strong> Artificial Intelligence</a></li><li class="chapter-item expanded affix "><li class="part-title">3D Related</li><li class="chapter-item expanded "><a href="../topics/3d.html"><strong aria-hidden="true">38.</strong> Developing 3D models</a></li><li class="chapter-item expanded "><a href="../topics/cloth.html"><strong aria-hidden="true">39.</strong> Cloth Simulation</a></li><li class="chapter-item expanded affix "><li class="part-title">Media Topics</li><li class="chapter-item expanded "><a href="../topics/audio.html"><strong aria-hidden="true">40.</strong> Audio Processing</a></li><li class="chapter-item expanded "><a href="../topics/broadcasting.html"><strong aria-hidden="true">41.</strong> Broadcasting</a></li><li class="chapter-item expanded "><a href="../topics/movie.html"><strong aria-hidden="true">42.</strong> Movie production tools</a></li><li class="chapter-item expanded "><a href="../topics/music.html"><strong aria-hidden="true">43.</strong> Music</a></li><li class="chapter-item expanded "><a href="../topics/dvd2mp4.html"><strong aria-hidden="true">44.</strong> Converting old DVDs/cd into mp4/mp3</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">My Development Cookbook</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="firestore-matters"><a class="header" href="#firestore-matters">Firestore matters</a></h1>
<h2 id="firestore-security"><a class="header" href="#firestore-security">Firestore security</a></h2>
<p>Cloud firestore is a database for a serverless architecture Firebase uses. Followings are notes I took from watching a google firebase team provided youtube playlist <a href="https://www.youtube.com/playlist?list=PLl-K7zZEsYLluG5MCVEzXAQ7ACZBCuZgZ">Get to know Cloud Firestore</a>.</p>
<h3 id="notes"><a class="header" href="#notes">Notes</a></h3>
<p>Document contains tree structure of information. But document does not contain another document. Maximum size ie 1 meg. Documents can point to a sub-collection. </p>
<pre><code class="language-javascript">document = {
    bird_type: &quot;swallow&quot;,
    airspeed: 42733,
    coconut_capacity: 0.62,
    isNative: false,
    icon: &lt;binary data&gt;,
    vector: {
        x: 36.4255, 
        y: 25.1442, 
        z: 18.8816
    } distances_traveled: [
        42,
        39,
        12,
        421
    ]
}
</code></pre>
<p>Collections only contains documents</p>
<pre><code class="language-javascript">collection = {
    hash1: document1
    hash2: document2 
}
</code></pre>
<p>At rhe root we will have a collection, so path to a document may look like,</p>
<pre><code class="language-javascript">var messageRef = firestore.collection('rooms').doc('roomA').collection('messages').doc('message1');
</code></pre>
<p>Each level fragment pattern will come in pair <code>.collection(...).doc(...)</code>.</p>
<p>Every field in a document is automatically indexed by Firestore. Depending on the search we may have create composite indexes
if a search fails. Firestore will send a link to console
which can be used to create exact composite index that is needed for that specific search.</p>
<p>Note, we will have to copy the composite index it back to our firestore project so that it will be pushed when we deploy next time.</p>
<blockquote>
<p>Question: does the firestore emulator do the same? Answer No.
Emulator will automatically build the indexes if it is missing.
there is no way currently to figure out what are the indexes
it built, although google might add it in the future. </p>
</blockquote>
<p>General rules</p>
<ul>
<li>Documents have limits.</li>
<li>You can't retrieve a partial document.</li>
<li>Queries are shallow.</li>
<li>You're billed by the number of reads and writes you perform.</li>
<li>Queries find documents in collections.</li>
<li>Arrays are weird.</li>
</ul>
<pre><code class="language-javascript">service cloud.firestore {
    match /databases/{database}/documents {
        match /{document=**} {
            // Completely locked
            allow read, write: if false;
        }
    }
}
</code></pre>
<pre><code class="language-javascript">service cloud.f1restore {
    match /databases/{database}/documents {
        match /restaurants/{restaurantID} {
            // restaurantID could be resturant_123
        }
        match /restaurants/{restaurantID}/reviews/{reviewID} {
        }
    }
}
</code></pre>
<p>wildcard</p>
<pre><code class="language-javascript">service cloud.f1restore {
    match /databases/{database}/documents {
        match /restaurants/{restOfPath=**} {
            // restOfPath could be resturant_123
            // or could be resturant_123/reviews/review_456
        }
        match /restaurants/{restaurantID}/reviews/{reviewID} {
        }
    }
}
</code></pre>
<pre><code class="language-javascript">service cloud.f1restore {
    match /databases/{database}/documents {
        match/restaurants/{restaurantID} {
            // restaurantID = The ID of the restaurant doc is available at this level 
            match /reviews/{reviewID} {
                // restaurantID = The ID of the restaurant doc available at this level
                // reviewID = The ID of the review doc is also available at this level
                allow write: if reviewID == &quot;review_234&quot;
            }
            // private data that only helps queries not to be sent back to client 
            match /private-data/{privateDoc} {
            }
        }
    }
}
</code></pre>
<pre><code class="language-javascript">service cloud.f1restore {
    match /databases/{database}/documents {
        match /{document=**} {
            //DO NOT LEAVE THIS IN, this will override everything else, RULES are OR-ED
            allow read, write;
        }
        match /users/{rest0fPath=**} {
            allow read;
        }
        match /users/{userID}/privateData/{privateDoc} {
            //Doesn't do anything
            allow read: if false;
        }
    }
}
</code></pre>
<p>read <a href="https://firebase.google.com/docs/auth/admin/custom-claims">Control Access with Custom Claims and Security Rules</a> to enable additional fields in Auth token.</p>
<p>access rule checks</p>
<pre><code class="language-javascript">// logged in users only 
service cloud.f1restore {
    match /databases/{database}/documents {
        match /myCollection/{docID} {
            allow read: if request.auth!= null;
        }
    }
}
// logged in users with google email
service cloud.f1restore {
    match /databases/{database}/documents {
        match /myCollection/{docID} {
            allow read: if request.auth.token.email.matches('.*google[.]com$');
        }
    }
}
// logged in users with google email and email verified
service cloud.f1restore {
    match /databases/{database}/documents {
        match /myCollection/{docID} {
            allow read: if request.auth.token.email.matches('.*google[.]com$') &amp;&amp;
                request.auth.token.email_verified;
        }
    }
}
// only logged in as albert 
service cloud.f1restore {
    match /databases/{database}/documents {
        match /myCollection/{docID} {
            allow read: if request.auth.uid == &quot;albert_245&quot;;
        }
    }
}

// role based access using private collection
allow update: if get(/databases/$(database)/documents/restaurants/$(restaurantID)/private_data/private).data.roles[request.auth.uid] == &quot;editor&quot;;

// multiple role access using private collection
allow update: if get(/databases/$(database)/documents/restaurants/$(restaurantID)/private_data/private).data.roles[request.auth.uid] in [&quot;editor&quot;, &quot;owner&quot;];
</code></pre>
<p>using functions</p>
<pre><code class="language-javascript">// logged in users with google email and email verified
service cloud.f1restore {
    match /databases/{database}/documents {
        match /myCollection/{docID} {
            function doesUserHaveGoogleAccuunt() {
                return request.auth.token.email.matches(
                    '.*google[.]com$')
                    &amp;&amp; request.auth.token.email_verified;
                }
            allow read: if doesUserHaveGoogleAccuunt();
        }
    }
}
</code></pre>
<p>or </p>
<pre><code class="language-javascript">service cloud.f1restore {
    match /databases/{database}/documents {
        function userIsRestaurantEditor(restaurantID) {
            return get(/databases/$(database)/documents/restaurants/$(restaurantID)/private_data/private)
                .data.roles[request.auth.uid] in [&quot;editor&quot;, &quot;owner&quot;];
        }
        match /restaurants/{restaurantID} {
            // restaurantID = The ID of the restaurant doc is available at this level 
            allow update: if userIsRestaurantEditor(restaurantID);
            match /reviews/{reviewID} {
                // restaurantID = The ID of the restaurant doc available at this level
                // reviewID = The ID of the review doc is also available at this level
            }
            // private data that only helps queries not to be sent back to client 
            match /private-data/{privateDoc} {
            }
        }
    }
}
</code></pre>
<p>To test rules use cloud firestore emulator.</p>
<p>pagination needs to be used save data transfer cost</p>
<pre><code class="language-javascript">// first page
myQuery = restaurantRef
    .whereFie1d(&quot;city&quot;, isEqualTo: &quot;Tokyo&quot;)
    .whereFie1d(&quot;category&quot;, isEqualTo: &quot;tempura&quot;)
    .order(by: &quot;rating”, descending: true)
    .limit(to: 20)
// next page
myQuery = restaurantRef
    .whereFie1d(&quot;city&quot;, isEqualTo: &quot;Tokyo&quot;)
    .whereFie1d(&quot;category&quot;, isEqualTo: &quot;tempura&quot;)
    .order(by: &quot;rating”, descending: true)
    .limit(to: 20)
    .start(after: [”Tokyo&quot;, “tempura&quot;, 4.9)

// or a simpler way, 
myQuery = myQuery.start(after: [”Tokyo&quot;, “tempura&quot;, 4.9])

// even easier 
myQuery = myQuery.start(after: previousDoc)
</code></pre>
<p>dont use .offset() because it will still bill you for the skipped data. </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../topics/firebase.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../topics/flutter.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../topics/firebase.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../topics/flutter.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
